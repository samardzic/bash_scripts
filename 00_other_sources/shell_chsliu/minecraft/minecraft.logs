#!/bin/bash

[ $mcver ] || [ "$0" == "-bash" ] || mcver=$(basename $0)

. /home/sita/script/include/console.color
. /home/sita/script/minecraft/alias/minecraft.color

# showstat() {

# [ ! -d "$MCPATH/logs" ] || LASTLOGS=(`ls -at $MCPATH/logs/*.log.gz`) >/dev/null
# [ ! $LASTLOGS ] || LOGLAST=${LASTLOGS[0]}
# [ $LASTLOGS ] || LOGLAST=/tmp/notexist
# LOGNOW="$MCPATH/logs/latest.log"
# [ -f $LOGNOW ] || LOGNOW=$LOG

# echo -e LASTLOGS=$LASTLOGS
# echo -e LOGLAST=$LOGLAST
# echo -e LOGNOW=$LOGNOW

# [ ! -f $LOGLAST ] || echo -e Last: $LOGLAST ...
# [ ! -f $LOGNOW ] || echo -e  Now: $LOGNOW ...

# echo -e -e "${GREEN}List of players joined/left time last time:${NC}"
# [ ! -f $LOGLAST ] || zcat $LOGLAST | grep 'joined\|left' 
# echo -e "-----"
# [ ! -f "$LOGNOW" ] || cat "$LOGNOW" | grep 'joined\|left'

# echo -e -e "${GREEN}List of players joined last time:${NC}"
# [ ! -f $LOGLAST ] || zcat $LOGLAST | grep joined | awk '{ printf ("%s %s\n", $4, $5) }' | sort | uniq
# echo -e "-----"
# [ ! -f "$LOGNOW" ] || cat "$LOGNOW" | grep joined | awk '{ printf ("%s %s\n", $4, $5) }' | sort | uniq

# echo -e -e "${GREEN}List of players slained last time:${NC}"
# [ ! -f $LOGLAST ] || zcat $LOGLAST | grep 'was\|burned\|fell\|swim\|blew\|suffocated\|swim\|hit the ground'
# echo -e "-----"
# [ ! -f "$LOGNOW" ] || cat "$LOGNOW" | grep 'was\|burned\|fell\|swim\|blew\|suffocated\|swim\|hit the ground'

# echo -e -e "${GREEN}List of players teleported last time:${NC}"
# [ ! -f $LOGLAST ] || zcat $LOGLAST | grep Teleported
# echo -e "-----"
# [ ! -f "$LOGNOW" ] || cat "$LOGNOW" | grep Teleported

# }

showstat() {
echo -e -e "${GREEN}List of players joined/left time last time:${NC}"
logs 0 | grep.left
echo -e "-----"
logs | grep.left
echo -e -e "${GREEN}List of players joined last time:${NC}"
logs 0 | grep.logged
echo -e "-----"
logs | grep.logged
echo -e -e "${GREEN}List of players slained last time:${NC}"
logs 0 | grep.slain
echo -e "-----"
logs | grep.slain
echo -e -e "${GREEN}List of players cheated last time:${NC}"
logs 0 | grep.cheater
echo -e "-----"
logs | grep.cheater
}

get_date() {
	echo -e $(stat -c %y "$1" | awk '{ printf ("[%s]\n", $1) }')
}

prefix_pipe() {
	sed -e "s/^/$1/"
}

date_prefix_cat() {
	prefix=$(stat -c %y $1 | awk '{ printf ("[%s]\n", $1) }')
	sed -e "s/^/$prefix/" $1
}

logs() {
	if [ -z ${1+x} ]; then 
		LOG=/mnt/runtimes/$mcver/logs/latest.log
		
		if [ -f $LOG ]; then 
			date_prefix_cat $LOG
		else
			LOG=/mnt/runtimes/$mcver/server.log
			if [ -f $LOG ]; then 
				cat $LOG
			fi
		fi
	else
		LASTLOGS=(`ls -at /mnt/runtimes/$mcver/logs/*.log.gz`)
		LOG=${LASTLOGS[$1]}
		# echo -e $LOG

		if [ -f "$LOG" ]; then 
			prefix=$(get_date $LOG)
			# zcat $LOG
			zcat $LOG | prefix_pipe $prefix
		fi
	fi
}

remove_ansi_color() {
    sed "s/\x1b\[[0-9;]*m//g"
}

# 
grep.player() {
	inputlog=`cat`
	linecnt=$(echo -e "${inputlog[*]}" | wc -l)
	# echo -e $linecnt, "${inputlog[*]}"
	if [ $linecnt -lt 2 ]; then return; fi

	players=$(echo -e "${inputlog[*]}" | grep -A 4 'players online\|çŽ©å®¶åœ¨ç·š' | tail -n +2 | remove_ansi_color | sed 's/\[[^]]*\]//g' | sed "s/[a-zA-Z]*://g" | sed 's/,//g')
	for player in $players
	do
		echo -e $player
	done
}

grep.logged() {
	grep logged | awk '{ printf ("%s %s\n", $4, $5) }' | sed 's/\[[^]]*\]//g' | sort | uniq
}

grep.left() {
	grep 'logged\|left'
}

# grep.teams() {
	# grep 'lost the achievement' | awk '{ printf ("%s\n", $4) }' | sort | uniq
# }

file.replace.teamtag() {
	[ -f $1 ] || { echo -e no file; return 1; }
	sed -i "s/$off//g" $1
	sed -i "s/$black/[é»‘éšŠ]/g" $1
	sed -i "s/$dark_blue/[B5æ·±è—éšŠ]/g" $1
	sed -i "s/$dark_green/[B3æ·±ç¶ éšŠ]/g" $1
	sed -i "s/$dark_aqua/[B4æ·±é’éšŠ]/g" $1
	sed -i "s/$dark_red/[B1æ·±ç´…éšŠ]/g" $1
	sed -i "s/$dark_purple/[B6æ·±ç´«éšŠ]/g" $1
	sed -i "s/$gold/[B2æ©˜éšŠ]/g" $1
	sed -i "s/$gray/[A7ç°éšŠ]/g" $1
	sed -i "s/$dark_gray/[B7æ·±ç°éšŠ]/g" $1
	sed -i "s/$blue/[A5è—éšŠ]/g" $1
	sed -i "s/$green/[A3ç¶ éšŠ]/g" $1
	sed -i "s/$aqua/[A4é’éšŠ]/g" $1
	sed -i "s/$red/[A1ç´…éšŠ]/g" $1
	sed -i "s/$light_purple/[A6äº®ç´«éšŠ]/g" $1
	sed -i "s/$yellow/[A2é»ƒéšŠ]/g" $1
	sed -i "s/$white/[ç™½éšŠ]/g" $1
}

file.cleanup() {
	[ -f $1 ] || { echo -e no file; return 1; }
	sed -i "s/ \[Server thread\/INFO\]//g" $1
}

file.replace.cause() {
	[ -f $1 ] || { echo -e no file; return 1; }
	sed -i "s/ using /ï¼Œä½¿ç”¨/g" $1
	sed -i "s/ blew up/è¢«ç‚¸æ­»äº†/g" $1
	sed -i "s/ burned to death/è¢«ç‡’æ­»/g" $1
	sed -i "s/ fell from a high place/å¾žé«˜è™•å¢œè½/g" $1
	sed -i "s/ fell out of the world/é›¢é–‹äº†äººä¸–/g" $1
	sed -i "s/ hit the ground too hard/æ’žæ“Šåœ°é¢å¤ªå¤§åŠ›/g" $1
	sed -i "s/ suffocated in a wall/çª’æ¯åœ¨ç‰†è£¡/g" $1
	sed -i "s/ tried to swim in lava to escape /åœ¨ç†”å²©è£¡æ¸¸æ³³,ç‚ºäº†é€ƒé¿/g" $1
	sed -i "s/ tried to swim in lava/åœ¨ç†”å²©è£¡æ¸¸æ³³/g" $1
	sed -i "s/ was killed by Witch using magic/è¢«å¥³å·«ç”¨é­”æ³•æ®ºæ­»/g" $1
	sed -i "s/ was killed by magic/è¢«é­”æ³•æ®ºæ­»/g" $1
	sed -i "s/ was pricked to death/è¢«åˆºæ­»äº†/g" $1
	sed -i "s/ was burnt to a crisp whilst fighting /åœ¨æˆ°é¬¥ä¸­è¢«ç‡’æ­»,å°æ‰‹æ˜¯/g" $1
	sed -i "s/ was shot by /è¢«å°„æ®ºäº†,å°„æ‰‹æ˜¯/g" $1
	sed -i "s/ was slain by /è¢«æ®ºäº†,æ®ºæ‰‹æ˜¯/g" $1
	sed -i "s/ left the game/ä¸çŽ©äº†/g" $1
	sed -i "s/ drowned/æ·¹æ­»äº†/g" $1
	sed -i "s/ was blown up by Creeper/è¢«è‹¦åŠ›æ€•ç‚¸é£›äº†/g" $1
}

file.replace.mob() {
	[ -f $1 ] || { echo -e no file; return 1; }
	sed -i "s/Cave Spider/æ´žç©´èœ˜è››/g" $1
	sed -i "s/Enderman/å®‰å¾·/g" $1
	sed -i "s/Husk/å±æ®¼/g" $1
	sed -i "s/Silverfish/è ¹é­š/g" $1
	sed -i "s/Skeleton/éª·é«/g" $1
	sed -i "s/Spider/èœ˜è››/g" $1
	sed -i "s/Zombie Villager/æ®­å±æ‘æ°‘/g" $1
	sed -i "s/Zombie/æ®­å±/g" $1
	sed -i "s/Creeper/è‹¦åŠ›æ€•/g" $1
	sed -i "s/Witch/å¥³å·«/g" $1
}

file.replace.escape() {
	[ -f $1 ] || { echo -e no file; return 1; }
	sed -i "s/\[0;30;1m//g" $1
    sed -i "s/\[0;31;1m//g" $1
    sed -i "s/\[0;32;1m//g" $1
    sed -i "s/\[0;33;1m//g" $1
    sed -i "s/\[0;34;1m//g" $1
    sed -i "s/\[0;35;1m//g" $1
    sed -i "s/\[0;36;1m//g" $1
    sed -i "s/\[0;37;1m//g" $1
    sed -i "s/\[0;30;22m//g" $1
    sed -i "s/\[0;31;22m//g" $1
    sed -i "s/\[0;32;22m//g" $1
    sed -i "s/\[0;33;22m//g" $1
    sed -i "s/\[0;34;22m//g" $1
    sed -i "s/\[0;35;22m//g" $1
    sed -i "s/\[0;36;22m//g" $1
    sed -i "s/\[0;37;22m//g" $1    
	sed -i "s/\[m//g" $1
	sed -i "s/\[21m//g" $1
}

grep.teams() {
	# list=$(grep 'lost the achievement' | awk '{ printf ("%s\n", $4) }' | sort | uniq)
	# list=$(grep achievement | grep Â§ | grep -v -x $black | awk '{ printf ("%s\n", $4) }' | sort | uniq | grep -v $black)
	list=$(grep Â§ | grep -v -x $black | awk '{ printf ("%s\n", $4) }' | sort | uniq | grep -v $black)
	list=$(echo -e $list | sed "s/$off//g")
	list=$(echo -e $list | sed "s/$black/[é»‘éšŠ]/g")
	list=$(echo -e $list | sed "s/$dark_blue/[B5æ·±è—éšŠ]/g")
	list=$(echo -e $list | sed "s/$dark_green/[B3æ·±ç¶ éšŠ]/g")
	list=$(echo -e $list | sed "s/$dark_aqua/[B4æ·±é’éšŠ]/g")
	list=$(echo -e $list | sed "s/$dark_red/[B1æ·±ç´…éšŠ]/g")
	list=$(echo -e $list | sed "s/$dark_purple/[B6æ·±ç´«éšŠ]/g")
	list=$(echo -e $list | sed "s/$gold/[B2æ©˜éšŠ]/g")
	list=$(echo -e $list | sed "s/$gray/[A7ç°éšŠ]/g")
	list=$(echo -e $list | sed "s/$dark_gray/[B7æ·±ç°éšŠ]/g")
	list=$(echo -e $list | sed "s/$blue/[A5è—éšŠ]/g")
	list=$(echo -e $list | sed "s/$green/[A3ç¶ éšŠ]/g")
	list=$(echo -e $list | sed "s/$aqua/[A4é’éšŠ]/g")
	list=$(echo -e $list | sed "s/$red/[A1ç´…éšŠ]/g")
	list=$(echo -e $list | sed "s/$light_purple/[A6äº®ç´«éšŠ]/g")
	list=$(echo -e $list | sed "s/$yellow/[A2é»ƒéšŠ]/g")
	list=$(echo -e $list | sed "s/$white/[ç™½éšŠ]/g")
	for item in $list
	do
		echo -e $item
	done
}

grep.slain() {
## blew up
## burned to death
## fell from a high place
## fell out of the world
## hit the ground too hard
## suffocated in a wall
## tried to swim in lava
## was burnt to a crisp
## was killed by magic
## was pricked to death
## was shot by 
## was slain by 
## left the game
## drowned
## was killed by Witch using magic
## was blown up by Creeper 
    # grep left\|
	grep 'blew\|burned\|fell from\|hit the ground\|suffocated\|swim\|burnt\|killed by magic\|pricked\|shot\|slain\|drowned\|using magic\|blown up\|å‚³é€å€’æ•¸è¨ˆæ™‚'
}

grep.winner() {
	inputlog=`cat`
	# left=/tmp/left.txt
	slainlist=/tmp/slain.txt
	# playerlist=/tmp/players.txt
	teamlist=/tmp/teams.txt
	
	# echo -e "${inputlog[*]}" | grep left | awk '{ printf ("%s\n", $4) }' | sort | uniq > $left
	echo -e "${inputlog[*]}" | grep.slain | awk '{ printf ("%s\n", $4) }' | sed 's/Â§.//g' > $slainlist
	# echo -e "${inputlog[*]}" | grep logged | awk '{ printf ("%s\n", $4) }' | sed 's/\[[^]]*\]//g' | sort | uniq > $playerlist
	echo -e "${inputlog[*]}" | grep.teams | sed 's/\[[^]]*\]//g' > $teamlist
	# echo -e "${inputlog[*]}" | grep.teams | awk '{ printf ("%s\n", $4) }' | sed 's/\[[^]]*\]//g' | sort | uniq > $playerlist
	# winners=$(cat $playerlist | grep -v -x -f $slainlist)
	cat $teamlist | grep -v -x -f $slainlist
	# for winner in $winners
	# do
		# echo -e $winner
		# echo -e "${inputlog[*]}" | grep $winner | grep.left
	# done
	
	rm $slainlist $teamlist
}

grep.cheater() {
	grep 'Teleported\|give'
}

grep.lag() {
	grep 'overloaded\|TPS has dropped\|free memory pool'
}

logs.grep() {
  case "$1" in
    list)
		mc_command list | grep.player
		;;
    logged)
		logs | grep.logged
		;;
    teams)
		logs | grep.teams | sort
		;;
    slain)
		logfile=/tmp/slain.log
		logs | grep.slain >$logfile
		file.cleanup $logfile
		file.replace.teamtag $logfile
		file.replace.cause $logfile
		file.replace.mob $logfile
		file.replace.escape $logfile
		cat $logfile
		;;
    winner)
		logs | grep.winner
		;;
    cheater)
		logs | grep.cheater
		;;
    lag)
		logs | grep.lag
		;;
    *)
    ;;
  esac
}
